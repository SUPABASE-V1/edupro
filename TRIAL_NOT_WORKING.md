# ?? Trial Not Working - Database Function Missing

**Date:** 2025-11-01  
**Issue:** 7-day trial not activating for independent users

---

## ?? The Problem

### **Trial Code is There:**

**In signup flow (line 177):**
```tsx
await supabase.rpc('start_user_trial', {
  target_user_id: authData.user.id,
  trial_days: 7,
  plan_tier: 'premium'
});
```

**But the database function `start_user_trial()` DOESN'T EXIST yet!**

---

## ? What Happens Now

```
1. User signs up as independent
2. Code tries to call: supabase.rpc('start_user_trial', ...)
3. Database returns: "function start_user_trial does not exist"
4. Code catches error (silent fail)
5. User gets NO trial ?
```

**Check browser console during signup:**
```
[Signup] Failed to start trial: { message: "function start_user_trial does not exist" }
```

---

## ? The Fix - Run Migration

You need to run this SQL file in your Supabase database:

**File:** `/workspace/RUN_THIS_TRIAL_MIGRATION.sql`

### **Quick Steps:**

1. **Open Supabase Dashboard** ? SQL Editor
2. **Copy the entire contents** of `RUN_THIS_TRIAL_MIGRATION.sql`
3. **Paste into SQL Editor**
4. **Click "Run"**
5. **Check for success message:** `? Migration completed successfully!`

---

## ?? What the Migration Does

### **1. Adds Trial Columns to `profiles` Table:**
```sql
- is_trial (BOOLEAN)
- trial_end_date (TIMESTAMP)
- trial_plan_tier (TEXT)
- trial_started_at (TIMESTAMP)
```

### **2. Creates RPC Functions:**

**`start_user_trial()`** - Activates trial
```sql
CREATE OR REPLACE FUNCTION start_user_trial(
  target_user_id UUID,
  trial_days INTEGER DEFAULT 7,
  plan_tier TEXT DEFAULT 'premium'
)
```

**`get_my_trial_status()`** - Checks trial status
```sql
CREATE OR REPLACE FUNCTION get_my_trial_status()
RETURNS json
```

**`has_premium_access()`** - Feature gating
```sql
CREATE OR REPLACE FUNCTION has_premium_access(user_id UUID)
RETURNS BOOLEAN
```

**`expire_user_trials()`** - Cleanup (for cron)
```sql
CREATE OR REPLACE FUNCTION expire_user_trials()
```

---

## ?? Test After Migration

### **Step 1: Run Migration**
```sql
-- In Supabase SQL Editor, run RUN_THIS_TRIAL_MIGRATION.sql
```

### **Step 2: Test Signup**
1. Sign up as new independent user
2. Select "School age (6-18 years)"
3. DON'T select organization
4. Complete signup
5. Check browser console for:
   ```
   [Signup] ? 7-day Premium trial started for user@example.com
   ```

### **Step 3: Check Database**
```sql
SELECT 
  id,
  email,
  is_trial,
  trial_end_date,
  trial_plan_tier,
  trial_started_at
FROM profiles
WHERE email = 'test@example.com';
```

**Should see:**
```
is_trial: true
trial_end_date: 7 days from now
trial_plan_tier: 'premium'
trial_started_at: now
```

### **Step 4: Check Dashboard**
1. Login to parent dashboard
2. Should see trial banner:
   ```
   ? 7 Days Left ? Premium Trial
   [Upgrade]
   ```

---

## ?? When Trial Activates

### **Current Flow (After Migration):**

```
???????????????????????????????????????
? 1. User signs up                    ?
?    - Email: test@example.com        ?
?    - Usage type: k12_school         ?
?    - Organization: NONE             ?
???????????????????????????????????????
              ?
???????????????????????????????????????
? 2. Account created in Supabase      ?
?    - User ID generated              ?
?    - Profile created by trigger     ?
???????????????????????????????????????
              ?
???????????????????????????????????????
? 3. Signup code checks:              ?
?    isIndependentUser?               ?
?    = !selectedOrganization &&       ?
?      !invitationCode                ?
???????????????????????????????????????
              ? YES
???????????????????????????????????????
? 4. Call start_user_trial RPC:       ?
?    supabase.rpc('start_user_trial') ?
???????????????????????????????????????
              ? (If function exists)
???????????????????????????????????????
? 5. Database updates profile:        ?
?    UPDATE profiles SET              ?
?      is_trial = TRUE,               ?
?      trial_end_date = NOW() + 7d,   ?
?      trial_plan_tier = 'premium'    ?
???????????????????????????????????????
              ?
???????????????????????????????????????
? 6. User redirected to:              ?
?    /sign-up/verify-email            ?
???????????????????????????????????????
              ?
???????????????????????????????????????
? 7. User verifies email              ?
???????????????????????????????????????
              ?
???????????????????????????????????????
? 8. User logs in                     ?
???????????????????????????????????????
              ?
???????????????????????????????????????
? 9. Dashboard loads                  ?
?    - Calls get_my_trial_status()    ?
?    - Shows trial banner             ?
?    ? 7 Days Left ? Premium Trial   ?
???????????????????????????????????????
```

---

## ?? Current State (Before Migration)

**Trial activation happens at:** Line 177 of `sign-up/parent/page.tsx`

**BUT it fails silently because:**
- Function doesn't exist in database
- Error is caught and logged to console
- Signup continues (user is created)
- User just doesn't get trial

**Console shows:**
```
[Signup] Failed to start trial: { 
  message: "function public.start_user_trial(uuid, integer, text) does not exist" 
}
```

---

## ?? Summary

**To activate trials:**
1. ? Code is ready (already in signup flow)
2. ? Database functions missing
3. ?? **ACTION REQUIRED:** Run `RUN_THIS_TRIAL_MIGRATION.sql`

**Once migration is run:**
- New signups will get 7-day Premium trials automatically
- Existing independent users can be given trials manually
- Trial banner will show on dashboard
- Premium features will be unlocked during trial

---

## ?? Quick Command

**Run this in Supabase SQL Editor:**
```sql
-- Copy entire contents of /workspace/RUN_THIS_TRIAL_MIGRATION.sql
-- Paste here
-- Click "Run"
```

**Expected output:**
```
? Migration completed successfully!
```

---

**Current Status:** ?? Trials NOT working (migration pending)  
**After Migration:** ?? Trials WILL work automatically
